<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DjuntaCar - Accueil</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-[#fcfcfd] antialiased">

    <header>
        <div class="header-left">
            <button onclick="toggleMenu()" class="profile-btn">
                <i data-lucide="menu" class="header-user-icon"></i>
            </button>
        </div>
        
        <div class="header-center">
            <img src="logo.png" alt="DjuntaCar" class="header-logo">
        </div>
        
        <div class="header-right">
            <button id="header-profile-btn" onclick="handleProfileClick()" class="profile-btn">
                <i data-lucide="user" class="header-user-icon"></i>
            </button>
        </div>
    </header>

    <section class="hero-section">
        <div class="nav-container">
            <div onclick="window.location.href='search-car.html'" class="search-bar-link">
                <div class="search-icon"><i data-lucide="search" class="w-4 h-4"></i></div>
                <div class="search-text">Trouver la voiture parfaite</div>
            </div>
        </div>
    </section>

    <div class="filter-wrapper">
        <div class="filter-grid">
            <button onclick="filterCars('all', this)" class="filter-btn active"><i data-lucide="layout-grid"></i> Tous</button>
            <button onclick="filterCars('4x4', this)" class="filter-btn"><i data-lucide="mountain"></i> 4x4</button>
            <button onclick="filterCars('citadine', this)" class="filter-btn"><i data-lucide="car"></i> Citas</button>
            <button onclick="filterCars('luxe', this)" class="filter-btn"><i data-lucide="gem"></i> Luxe</button>
        </div>
    </div

    <main class="content-padding vertical-list" id="cars-container">
        <div class="text-center py-10">
            <i data-lucide="loader" class="animate-spin w-8 h-8 text-[#1d4379] mx-auto mb-2"></i>
            <p class="text-xs font-bold text-gray-400">Chargement...</p>
        </div>
    </main>

    <div class="fixed-footer">
        <button onclick="window.location.href='add-car.html'" class="btn-action btn-primary">Ajouter ma voiture</button>
        <button onclick="window.location.href='driver-application.html'" class="btn-action btn-success">Devenir chauffeur</button>
    </div>

    <div id="menu-overlay" onclick="toggleMenu()"></div>
    <div id="universal-menu">
        <div class="menu-header">
            <img src="logo.png" style="height: 32px;">
            <button onclick="toggleMenu()"><i data-lucide="x" style="width: 24px; color: #1d4379;"></i></button>
        </div>
        <nav class="menu-nav">
            <a href="index.html" class="menu-link current-page"><i data-lucide="home"></i> Accueil</a>
            <a href="search-car.html" class="menu-link"><i data-lucide="search"></i> Recherche</a>
            <a href="my-rentals.html" class="menu-link"><i data-lucide="calendar"></i> Mes Locations</a>
            <a href="profile.html" class="menu-link"><i data-lucide="user"></i> Profil</a>
        </nav>
        <div class="menu-footer">
            <button onclick="logout()" class="btn-logout"><i data-lucide="log-out"></i> Déconnexion</button>
        </div>
    </div>

    <script>
        lucide.createIcons();
        function toggleMenu() { document.getElementById('universal-menu').classList.toggle('open'); document.getElementById('menu-overlay').classList.toggle('open'); }
        
      // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://enuiuuwnjzvpfvpklmjw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVudWl1dXduanp2cGZ2cGtsbWp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNjIwMzMsImV4cCI6MjA4NDczODAzM30.Ry4beH9ki0sql51XWo5eA1iRluFokVKClaDnbuUGxGA
';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null; // Stocke l'info utilisateur

        // 1. INITIALISATION GLOBALE
        async function init() {
            checkSession(); // Vérifie qui est connecté pour l'icône
            fetchCars();    // Charge les voitures
        }

        // 2. GESTION INTELLIGENTE DE L'ICÔNE PROFIL
        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            const btn = document.getElementById('header-profile-btn');

            if (session) {
                // CAS 1 : CONNECTÉ
                currentUser = session.user;
                // On remplace l'icône par l'image (avatar par défaut ou google)
                const avatarUrl = session.user.user_metadata.avatar_url || 'https://i.pravatar.cc/150?img=12'; // Image test si pas d'avatar
                
                btn.innerHTML = `<img src="${avatarUrl}" class="header-user-img" alt="Profil">`;
            } else {
                // CAS 2 : PAS CONNECTÉ
                currentUser = null;
                // On s'assure que c'est l'icône par défaut
                btn.innerHTML = `<i data-lucide="user" class="header-user-icon"></i>`;
                lucide.createIcons();
            }
        }

        // 3. CLIC SUR L'ICÔNE PROFIL
        function handleProfileClick() {
            if (currentUser) {
                window.location.href = 'profile.html'; // Si connecté -> Profil
            } else {
                window.location.href = 'login.html';   // Si pas connecté -> Connexion
            }
        }

        function logout() {
            supabase.auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // --- (Le reste du code fetchCars est identique à avant) ---
        async function fetchCars() {
            const { data, error } = await supabase.from('cars').select('*');
            if(!error) renderCars(data);
        }
        function renderCars(cars) {
            const container = document.getElementById('cars-container');
            if(cars.length === 0) { container.innerHTML = '<p class="text-center text-xs mt-10">Aucune voiture.</p>'; return; }
            
            container.innerHTML = cars.map(car => `
                <div class="car-card" onclick="window.location.href='car-detail.html?id=${car.id}'">
                    <div class="card-image-box">
                        <div class="badge-container"><span class="badge verified">Vérifié</span></div>
                        <img src="${car.image_url}" onerror="this.src='https://via.placeholder.com/400'">
                        <div class="location-pill"><i data-lucide="map-pin" class="w-3 h-3"></i> ${car.location}</div>
                    </div>
                    <div class="card-details">
                        <div class="card-title-row">
                            <h3 class="card-title">${car.brand} ${car.model}</h3>
                            <div class="rating"><i data-lucide="star" class="w-3 h-3 fill-amber-500"></i> 5.0</div>
                        </div>
                        <div class="card-footer-row">
                            <span class="btn-text">Détails</span>
                            <p class="price-display">${car.price_per_day} <span class="price-suffix">CVE</span></p>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        init();
    </script>
</body>
</html>
