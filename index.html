<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DjuntaCar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1A4384',
                        secondary: '#0f2a52',
                        accent: '#76B852',
                    }
                }
            }
        }
    </script>
    <style>
        /* Effet de verre (Glassmorphism) */
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        body { background-color: #F9FAFB; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <header class="fixed top-0 w-full z-50 glass border-b border-gray-200">
        <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 font-bold text-primary text-xl">
                <i data-lucide="car-front" class="w-6 h-6"></i>
                DjuntaCar
            </div>
            <div class="flex items-center gap-2 text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1 rounded-full">
                <span>ðŸ‡«ðŸ‡· FR</span>
                <i data-lucide="chevron-down" class="w-3 h-3"></i>
            </div>
        </div>
    </header>

    <div class="bg-gradient-to-br from-[#1A4384] via-[#1A4384] to-[#0f2a52] pt-24 pb-12 px-4 text-white rounded-b-[2rem] shadow-lg">
        <div class="max-w-md mx-auto">
            <h1 class="text-3xl font-bold mb-2">OÃ¹ voulez-vous aller ?</h1>
            <p class="text-blue-100 text-sm mb-6 flex items-center gap-2">
                <i data-lucide="map-pin" class="w-4 h-4"></i>
                Mobilidadi pa tudu Cabo Verde ðŸ‡¨ðŸ‡»
            </p>
            
            <div class="relative">
                <select id="island-select" onchange="applyFilters()" class="w-full appearance-none bg-white/10 border border-white/20 text-white py-3 px-4 rounded-xl backdrop-blur-md outline-none focus:border-white/50 transition-colors">
                    <option value="all" class="text-gray-800">Toutes les Ã®les</option>
                    <option value="Santiago" class="text-gray-800">Santiago (Praia)</option>
                    <option value="Sal" class="text-gray-800">Sal</option>
                    <option value="SaoVicente" class="text-gray-800">SÃ£o Vicente</option>
                </select>
                <i data-lucide="chevron-down" class="absolute right-4 top-3.5 w-5 h-5 text-white pointer-events-none"></i>
            </div>
        </div>
    </div>

    <main class="max-w-md mx-auto px-4 -mt-6 relative z-10">
        
        <div class="flex gap-2 overflow-x-auto pb-4 scrollbar-hide mb-2">
            <button onclick="setCategory('all', this)" class="cat-btn active bg-primary text-white px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap shadow-md transition-all">Tous</button>
            <button onclick="setCategory('citadina', this)" class="cat-btn bg-white text-gray-600 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap shadow-sm border border-gray-100">Citadines</button>
            <button onclick="setCategory('4x4_aventura', this)" class="cat-btn bg-white text-gray-600 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap shadow-sm border border-gray-100">4x4 Aventura</button>
            <button onclick="setCategory('premium', this)" class="cat-btn bg-white text-gray-600 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap shadow-sm border border-gray-100">Premium</button>
        </div>

        <div id="vehicle-grid" class="grid grid-cols-1 gap-4">
            <div class="flex flex-col items-center justify-center py-12 text-gray-400">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-2"></i>
                <span class="text-sm">Chargement des vÃ©hicules...</span>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 pb-safe z-50">
        <div class="max-w-md mx-auto flex justify-around items-center h-16">
            <button class="flex flex-col items-center text-primary">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium mt-1">Accueil</span>
            </button>
            <button class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                <i data-lucide="calendar" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium mt-1">RÃ©servations</span>
            </button>
            <button class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                <i data-lucide="message-circle" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium mt-1">Messages</span>
            </button>
            <button class="flex flex-col items-center text-gray-400 hover:text-gray-600">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-[10px] font-medium mt-1">Profil</span>
            </button>
        </div>
    </nav>

    <script>
        // 1. Initialisation des Icones
        lucide.createIcons();

        // 2. Connexion Supabase
        const SUPABASE_URL = 'https://enuiuuwnjzvpfvpklmjw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_MDe_Df6NgeA-MmeP1pguPQ_tgF2k8s-';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 3. Variables Globales
        let allVehicles = [];
        let currentCategory = 'all';

        // 4. Fonction Principale
        async function loadApp() {
            const grid = document.getElementById('vehicle-grid');
            
            try {
                // RÃ©cupÃ©ration des donnÃ©es
                const { data, error } = await supabase.from('vehicles').select('*').eq('is_active', true);
                
                if (error) throw error;

                // ASTUCE: On assigne une Ã®le alÃ©atoire pour que le filtre fonctionne (Simulation)
                // Hilux/Duster -> Santiago | Jimny -> Sal | Autres -> Mixte
                allVehicles = data.map(car => ({
                    ...car,
                    island: car.model.includes('Hilux') ? 'Santiago' : 
                            car.model.includes('Jimny') ? 'Sal' : 
                            car.model.includes('Hiace') ? 'SaoVicente' : 'Santiago'
                }));

                applyFilters();

            } catch (err) {
                console.error("Erreur:", err);
                grid.innerHTML = `
                    <div class="bg-red-50 text-red-600 p-4 rounded-xl text-center text-sm border border-red-100">
                        <p class="font-bold">Erreur de connexion</p>
                        <p>${err.message}</p>
                    </div>`;
            }
        }

        // 5. Moteur de Filtrage
        function applyFilters() {
            const island = document.getElementById('island-select').value;
            const grid = document.getElementById('vehicle-grid');

            // Filtrer
            const filtered = allVehicles.filter(car => {
                const matchIsland = island === 'all' || car.island === island;
                const matchCat = currentCategory === 'all' || car.category === currentCategory;
                return matchIsland && matchCat;
            });

            // Afficher
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <div class="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="car-front" class="w-8 h-8 opacity-50"></i>
                        </div>
                        <p>Aucun vÃ©hicule disponible ici.</p>
                    </div>`;
            } else {
                grid.innerHTML = filtered.map(car => createCard(car)).join('');
            }
            lucide.createIcons(); // RafraÃ®chir les icones
        }

        // 6. CrÃ©ation de la Carte (HTML)
        function createCard(car) {
            const img = (car.images_url && car.images_url.length) ? car.images_url[0] : 'https://via.placeholder.com/400';
            
            return `
            <div onclick="alert('DÃ©tail pour ${car.make} ${car.model}')" class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 active:scale-[0.98] transition-transform duration-150 cursor-pointer">
                <div class="relative h-48 bg-gray-200">
                    <img src="${img}" class="w-full h-full object-cover" loading="lazy" alt="${car.make}">
                    <div class="absolute top-3 right-3 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-primary shadow-sm">
                        ${car.price_per_day.toLocaleString()} CVE<span class="font-normal text-gray-500">/j</span>
                    </div>
                    <div class="absolute bottom-3 left-3 bg-black/50 backdrop-blur-md text-white px-2 py-1 rounded-lg text-[10px] flex items-center gap-1">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> ${car.island}
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg text-gray-900 leading-tight">${car.make} ${car.model}</h3>
                            <p class="text-xs text-gray-500 mt-0.5 capitalize">${car.category.replace('_', ' ')}</p>
                        </div>
                        <div class="flex items-center gap-1 text-accent text-xs font-bold bg-green-50 px-2 py-1 rounded-lg">
                            <i data-lucide="check-circle-2" class="w-3 h-3"></i> Dispo
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4 text-xs text-gray-500 mt-3 pt-3 border-t border-gray-50">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="fuel" class="w-4 h-4 text-primary/70"></i>
                            ${car.fuel_type || 'Essence'}
                        </div>
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="joystick" class="w-4 h-4 text-primary/70"></i>
                            ${car.transmission || 'Manuelle'}
                        </div>
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="users" class="w-4 h-4 text-primary/70"></i>
                            ${car.seats || 4} pl.
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // 7. Gestion des Boutons CatÃ©gorie
        window.setCategory = (cat, btn) => {
            currentCategory = cat;
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.className = `cat-btn bg-white text-gray-600 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap shadow-sm border border-gray-100 transition-all`;
            });
            btn.className = `cat-btn active bg-primary text-white px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap shadow-md transition-all`;
            applyFilters();
        }

        // DÃ©marrage
        loadApp();
    </script>
</body>
</html>
