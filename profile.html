<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Espace - DjuntaCar</title>
    <link rel="icon" type="image/png" href="sigle.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap');
        body { font-family: 'Montserrat', sans-serif; background-color: #F9FAFB; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .role-badge { font-size: 9px; font-weight: 800; padding: 2px 8px; border-radius: 99px; text-transform: uppercase; letter-spacing: 0.5px; }
    </style>
</head>
<body class="pb-24">

    <header class="fixed top-0 w-full z-50 glass border-b border-gray-200">
        <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-lg font-extrabold text-[#1d4379]">Mon Profil</h1>
            <button onclick="logout()" class="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-lg hover:bg-red-100 transition-colors">
                Déconnexion
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 pt-24">

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6 flex flex-col items-center text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-[#1d4379]"></div>
            
            <div class="w-20 h-20 bg-[#1d4379] text-white rounded-full flex items-center justify-center text-3xl font-black mb-4 shadow-lg" id="avatar">
                ?
            </div>
            
            <h2 id="user-name" class="font-extrabold text-xl text-gray-900">Chargement...</h2>
            <p id="user-email" class="text-xs text-gray-400 font-medium mb-3">...</p>
            
            <div id="role-container" class="flex flex-wrap justify-center gap-2">
                </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <a href="add-car.html" class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col items-center gap-2 active:scale-95 transition-transform">
                <div class="bg-blue-50 p-3 rounded-full text-[#1d4379]">
                    <i data-lucide="plus-square" class="w-6 h-6"></i>
                </div>
                <span class="text-[11px] font-extrabold text-[#1d4379] uppercase">Ajouter voiture</span>
            </a>
            <button onclick="alert('Bientôt disponible')" class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col items-center gap-2 active:scale-95 transition-transform">
                <div class="bg-green-50 p-3 rounded-full text-green-600">
                    <i data-lucide="calendar" class="w-6 h-6"></i>
                </div>
                <span class="text-[11px] font-extrabold text-green-600 uppercase">Mes Réservations</span>
            </a>
        </div>

        <div id="owner-section" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-extrabold text-gray-900 flex items-center gap-2">
                    <i data-lucide="car" class="w-5 h-5 text-[#1d4379]"></i> Mon Garage
                </h3>
                <span id="car-count" class="bg-gray-100 text-gray-600 text-[10px] font-black px-2 py-1 rounded-lg">0</span>
            </div>

            <div id="my-cars-list" class="space-y-4">
                </div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-100 pb-safe z-50">
        <div class="max-w-md mx-auto flex justify-around items-center h-20 px-2">
            <a href="index.html" class="flex flex-col items-center w-16 text-gray-400 hover:text-[#1d4379] transition-colors">
                <i data-lucide="home" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-bold">Accueil</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center w-16 text-[#1d4379]">
                <i data-lucide="user" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px] font-bold">Profil</span>
            </a>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            if(window.lucide) lucide.createIcons();

            const SUPABASE_URL = 'https://enuiuuwnjzvpfvpklmjw.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_MDe_Df6NgeA-MmeP1pguPQ_tgF2k8s-';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            const user = session.user;

            // 1. RÉCUPÉRER LE PROFIL ET LES RÔLES
            let { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (!profile) return;

            // 2. AFFICHER LES INFOS DE BASE
            const name = profile.full_name || "Utilisateur";
            document.getElementById('user-name').innerText = name;
            document.getElementById('user-email').innerText = user.email;
            document.getElementById('avatar').innerText = name.charAt(0).toUpperCase();

            // 3. LOGIQUE DES BADGES DE RÔLES
            const roleContainer = document.getElementById('role-container');
            const roles = profile.roles || ['client'];
            
            const roleStyles = {
                client: { label: 'Voyageur', class: 'bg-gray-100 text-gray-600' },
                owner: { label: 'Propriétaire', class: 'bg-blue-100 text-[#1d4379]' },
                driver: { label: 'Chauffeur', class: 'bg-green-100 text-green-700' }
            };

            roleContainer.innerHTML = roles.map(role => `
                <span class="role-badge ${roleStyles[role]?.class || 'bg-gray-100'}">
                    ${roleStyles[role]?.label || role}
                </span>
            `).join('');

            // 4. SI PROPRIÉTAIRE -> CHARGER LES VOITURES
            if (roles.includes('owner')) {
                document.getElementById('owner-section').classList.remove('hidden');
                fetchMyCars(supabase, user.id);
            }

            lucide.createIcons();
        });

        async function fetchMyCars(supabase, userId) {
            const list = document.getElementById('my-cars-list');
            const { data: cars } = await supabase
                .from('vehicles')
                .select('*')
                .eq('owner_id', userId);

            document.getElementById('car-count').innerText = cars ? cars.length : 0;

            if (!cars || cars.length === 0) {
                list.innerHTML = `<p class="text-center py-6 text-xs text-gray-400 font-bold border-2 border-dashed rounded-2xl">Aucune voiture ajoutée</p>`;
            } else {
                list.innerHTML = cars.map(car => `
                    <div class="bg-white p-3 rounded-2xl border border-gray-100 shadow-sm flex gap-4 items-center">
                        <img src="${car.images_url?.[0]}" class="w-16 h-16 rounded-xl object-cover bg-gray-50">
                        <div class="flex-1">
                            <h4 class="font-extrabold text-sm text-gray-900">${car.make} ${car.model}</h4>
                            <p class="text-[10px] text-gray-400 font-bold uppercase">${car.island} • ${car.price_per_day} CVE</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                    </div>
                `).join('');
                lucide.createIcons();
            }
        }

        window.logout = async () => {
            const supabase = window.supabase.createClient('https://enuiuuwnjzvpfvpklmjw.supabase.co', 'sb_publishable_MDe_Df6NgeA-MmeP1pguPQ_tgF2k8s-');
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
