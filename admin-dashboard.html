<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DjuntaCar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Montserrat', sans-serif !important; }
        body { background-color: #f1f5f9; }
        .stat-card { background: white; padding: 24px; border-radius: 24px; border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="p-8">

    <header class="flex justify-between items-center mb-10">
        <div>
            <h1 class="text-2xl font-black text-[#1d4379]">Administration</h1>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Supervision DjuntaCar Cap-Vert</p>
        </div>
        <div class="flex gap-4">
            <button class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm relative">
                <i data-lucide="bell" class="text-gray-400"></i>
                <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="stat-card">
            <span class="text-[10px] font-black text-gray-400 uppercase">Volume d'affaires (Total)</span>
            <div class="flex items-baseline gap-2 mt-2">
                <h2 id="total-gmv" class="text-2xl font-black text-[#1d4379]">0 CVE</h2>
            </div>
            <p id="total-gmv-eur" class="text-[10px] font-bold text-gray-400 mt-1">≈ 0 EUR</p>
        </div>
        <div class="stat-card border-l-4 border-blue-500">
            <span class="text-[10px] font-black text-blue-500 uppercase">Revenu Plateforme (15%)</span>
            <h2 id="rev-platform" class="text-2xl font-black text-[#1d4379] mt-2">0 CVE</h2>
            <p class="text-[10px] font-bold text-gray-400 mt-1">Fonds de fonctionnement</p>
        </div>
        <div class="stat-card border-l-4 border-green-500">
            <span class="text-[10px] font-black text-green-500 uppercase">Fonds Assurance (10%)</span>
            <h2 id="rev-insurance" class="text-2xl font-black text-[#1d4379] mt-2">0 CVE</h2>
            <p class="text-[10px] font-bold text-gray-400 mt-1">Couverture sinistres</p>
        </div>
    </div>

    <div class="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-6 border-b border-gray-50 flex justify-between items-center">
            <h3 class="font-black text-[#1d4379] text-sm uppercase">Validations de comptes en attente</h3>
            <span class="bg-amber-100 text-amber-600 px-3 py-1 rounded-full text-[10px] font-black" id="kyc-count">0 ATTENTE</span>
        </div>
        <table class="w-full text-left">
            <thead class="bg-gray-50 text-[10px] font-black text-gray-400 uppercase">
                <tr>
                    <th class="px-6 py-4">Utilisateur</th>
                    <th class="px-6 py-4">Rôle</th>
                    <th class="px-6 py-4">Document</th>
                    <th class="px-6 py-4 text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="kyc-table" class="text-xs font-bold text-gray-600">
                </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        lucide.createIcons();
        const supabase = window.supabase.createClient('URL', 'KEY');
        const EUR_RATE = 110.265;

        async function loadAdminData() {
            // 1. Calcul des revenus (Logic 15%/10%)
            const { data: bookings } = await supabase.from('bookings').select('total_price').eq('status', 'completed');
            let totalCVE = bookings.reduce((sum, b) => sum + b.total_price, 0);
            
            document.getElementById('total-gmv').innerText = totalCVE.toLocaleString() + ' CVE';
            document.getElementById('total-gmv-eur').innerText = `≈ ${(totalCVE / EUR_RATE).toFixed(2)} EUR`;
            document.getElementById('rev-platform').innerText = Math.round(totalCVE * 0.15).toLocaleString() + ' CVE';
            document.getElementById('rev-insurance').innerText = Math.round(totalCVE * 0.10).toLocaleString() + ' CVE';

            // 2. Liste KYC
            const { data: users } = await supabase.from('profiles').select('*').eq('kyc_status', 'pending');
            document.getElementById('kyc-count').innerText = `${users.length} EN ATTENTE`;

            const table = document.getElementById('kyc-table');
            table.innerHTML = users.map(u => `
                <tr class="border-t border-gray-50">
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span>${u.full_name}</span>
                            <span class="text-[10px] text-gray-400">${u.email}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 uppercase text-[10px]">${u.role}</td>
                    <td class="px-6 py-4">
                        <button class="text-blue-500 hover:underline">Voir Permis</button>
                    </td>
                    <td class="px-6 py-4 text-right flex justify-end gap-2">
                        <button onclick="verifyUser('${u.id}', 'verified')" class="bg-green-500 text-white p-2 rounded-lg"><i data-lucide="check" class="w-4 h-4"></i></button>
                        <button onclick="verifyUser('${u.id}', 'rejected')" class="bg-red-500 text-white p-2 rounded-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function verifyUser(id, status) {
            await supabase.from('profiles').update({ kyc_status: status }).eq('id', id);
            loadAdminData();
        }

        loadAdminData();
    </script>
</body>
</html>
