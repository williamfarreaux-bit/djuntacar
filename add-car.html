<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DjuntaCar - Ajouter un véhicule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50 pb-24">
    <header class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
            <a href="profile.html" class="text-gray-500 hover:text-[#1d4379] flex items-center gap-1">
                <i data-lucide="arrow-left" class="w-5 h-5"></i> Retour
            </a>
            <h1 class="text-lg font-bold text-[#1d4379]">Nouveau Véhicule</h1>
            <div class="w-10"></div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4">
        <form id="add-car-form">
            </form>
    </main>

    <script type="module">
        import { supabase, getCurrentUser } from './services/supabase.js';
        lucide.createIcons();

        // Gestion de l'affichage du nom de fichier
        const fileInput = document.getElementById('photo-upload');
        fileInput.addEventListener('change', function() {
            if(this.files.length > 0) {
                alert("Photo sélectionnée : " + this.files[0].name);
            }
        });

        document.getElementById('add-car-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Envoi...';
            lucide.createIcons();

            try {
                // 1. Qui est connecté ?
                const user = await getCurrentUser();
                if (!user) throw new Error("Vous devez être connecté");

                // 2. Récupération des données du formulaire
                const formData = new FormData(e.target);
                const carData = Object.fromEntries(formData.entries());
                const photoFile = document.getElementById('photo-upload').files[0];

                if (!photoFile) throw new Error("Veuillez ajouter une photo du véhicule");

                // 3. Upload de la photo dans le Storage
                const fileName = `${user.id}/${Date.now()}_${photoFile.name}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('car-photos')
                    .upload(fileName, photoFile);

                if (uploadError) throw uploadError;

                // 4. Récupération de l'URL publique de la photo
                const { data: { publicUrl } } = supabase.storage
                    .from('car-photos')
                    .getPublicUrl(fileName);

                // 5. Sauvegarde dans la table 'vehicles'
                const { error: dbError } = await supabase
                    .from('vehicles')
                    .insert([{
                        owner_id: user.id,
                        make: carData.make,
                        model: carData.model,
                        category: carData.category,
                        island: carData.island,
                        transmission: carData.transmission,
                        fuel_type: carData.fuel,
                        price_per_day: parseInt(carData.price),
                        images_url: [publicUrl], // On met l'URL dans un tableau
                        is_active: true // On active direct pour le test (normalement false)
                    }]);

                if (dbError) throw dbError;

                // Succès !
                alert("Véhicule ajouté avec succès !");
                window.location.href = 'profile.html';

            } catch (error) {
                console.error(error);
                alert("Erreur : " + error.message);
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
