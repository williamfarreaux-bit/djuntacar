<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DjuntaCar - Résultats</title>
    
    <meta name="theme-color" content="#1d4379">

    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="config.js"></script>
    <script src="layout.js" defer></script>

    <style>
        body { background-color: #f8fafc; padding-bottom: 40px; font-family: 'Montserrat', sans-serif; }

        /* BARRE RÉCAPITULATIVE DE RECHERCHE (Sticky) */
        .search-summary {
            background: white;
            position: sticky; top: 70px; /* Juste sous le header de 70px */
            z-index: 900;
            padding: 16px 20px;
            border-bottom: 1px solid #f1f5f9;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .summary-info h2 { font-size: 14px; font-weight: 900; color: #1d4379; text-transform: uppercase; line-height: 1.2; }
        .summary-info p { font-size: 10px; font-weight: 700; color: #94a3b8; margin-top: 2px; }
        
        .btn-edit {
            background: #eff6ff; color: #1d4379;
            padding: 8px 16px; border-radius: 12px;
            font-size: 10px; font-weight: 800; text-transform: uppercase;
            border: 1px solid #dbeafe;
        }

        /* LISTE RÉSULTATS */
        .results-list { padding: 20px; display: flex; flex-direction: column; gap: 20px; }

        .result-card {
            background: white; border-radius: 24px; overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #f1f5f9;
            display: flex; flex-direction: column;
            transition: transform 0.2s;
        }
        .result-card:active { transform: scale(0.98); }

        .card-image { height: 180px; width: 100%; position: relative; }
        .card-image img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-badge {
            position: absolute; top: 12px; left: 12px;
            background: rgba(29, 67, 121, 0.9); backdrop-filter: blur(4px);
            color: white; font-size: 9px; font-weight: 800;
            padding: 4px 10px; border-radius: 8px; text-transform: uppercase;
        }

        .card-content { padding: 20px; }
        
        .price-tag {
            background: #f0fdf4; color: #166534;
            padding: 6px 12px; border-radius: 10px;
            font-size: 12px; font-weight: 900;
            display: inline-block; border: 1px solid #bbf7d0;
        }
    </style>
</head>
<body>

    <div class="search-summary">
        <div class="summary-info">
            <h2 id="summary-location">...</h2>
            <p id="summary-dates">...</p>
        </div>
        <button onclick="window.history.back()" class="btn-edit">
            Modifier
        </button>
    </div>

    <main class="results-list" id="results-container">
        <div class="flex flex-col items-center justify-center py-20 gap-4 opacity-50">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-[#1d4379]"></i>
            <p class="text-[10px] font-black uppercase tracking-widest text-[#1d4379]">Recherche des meilleurs tarifs...</p>
        </div>
    </main>

    <script>
        const supabase = window.supabase.createClient(DJUNTA_CONFIG.supabaseUrl, DJUNTA_CONFIG.supabaseKey);

        // Récupération des paramètres URL
        const params = new URLSearchParams(window.location.search);
        const locationFilter = params.get('location') || 'Tous';
        const startDate = params.get('start');
        const endDate = params.get('end');
        const categoryFilter = params.get('category') || 'all';

        // Calcul durée
        let durationDays = 1;
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            durationDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if(durationDays < 1) durationDays = 1;
        }

        // Affichage Infos Header
        document.getElementById('summary-location').innerText = `À ${locationFilter}`;
        if(startDate) {
            const options = { day: 'numeric', month: 'short' };
            const d1 = new Date(startDate).toLocaleDateString('fr-FR', options);
            const d2 = new Date(endDate).toLocaleDateString('fr-FR', options);
            document.getElementById('summary-dates').innerText = `${d1} - ${d2} (${durationDays} jours)`;
        } else {
            document.getElementById('summary-dates').innerText = "Dates flexibles";
        }

        async function fetchResults() {
            const container = document.getElementById('results-container');
            
            try {
                // Construction de la requête
                let query = supabase
                    .from('vehicles')
                    .select('*')
                    .eq('is_driver_included', false) // Uniquement location pure
                    .order('price_per_day', { ascending: true }); // Du moins cher au plus cher

                // Filtre par catégorie (si pas 'all')
                if (categoryFilter !== 'all') {
                    // Note: Assurez-vous que votre colonne s'appelle bien 'category' ou 'type' dans Supabase
                    // query = query.eq('category', categoryFilter); 
                }

                // Filtre par Lieu (Optionnel : désactivé pour montrer des résultats même si vide)
                // Si vous voulez être strict, décommentez :
                // if (locationFilter !== 'Tous') query = query.eq('location', locationFilter);

                const { data: cars, error } = await query;

                if (error) throw error;

                container.innerHTML = '';

                if (!cars || cars.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-20 px-10">
                            <div class="bg-gray-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="search-x" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <h3 class="font-black text-[#1d4379] text-lg mb-2">Aucun résultat</h3>
                            <p class="text-xs font-medium text-gray-400">Essayez de modifier vos filtres ou changez de lieu.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                cars.forEach(car => {
                    // Calcul Prix Total
                    const totalPrice = car.price_per_day * durationDays;

                    // Création de l'URL vers le détail avec transfert des dates
                    const detailUrl = `car-detail.html?id=${car.id}&start=${startDate}&end=${endDate}`;

                    container.insertAdjacentHTML('beforeend', `
                        <div class="result-card" onclick="window.location.href='${detailUrl}'">
                            <div class="card-image">
                                <img src="${car.image_url}" loading="lazy" onerror="this.src='https://via.placeholder.com/400x300?text=Auto'">
                                <div class="card-badge">
                                    ${car.category || 'Standard'}
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-lg font-black text-[#1d4379] uppercase leading-tight">${car.brand} ${car.model}</h3>
                                        <div class="flex items-center gap-1 mt-2 text-[10px] font-bold text-gray-400 uppercase">
                                            <i data-lucide="map-pin" class="w-3 h-3"></i> ${car.location || locationFilter}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="price-tag">${totalPrice.toLocaleString()} CVE</div>
                                        <p class="text-[9px] font-bold text-gray-400 mt-1 uppercase">Total pour ${durationDays} nuits</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-3 border-t border-gray-50 pt-3">
                                    <div class="flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded text-[9px] font-bold text-gray-500 uppercase">
                                        <i data-lucide="fuel" class="w-3 h-3"></i> ${car.fuel_type || 'Essence'}
                                    </div>
                                    <div class="flex items-center gap-1.5 bg-gray-50 px-2 py-1 rounded text-[9px] font-bold text-gray-500 uppercase">
                                        <i data-lucide="settings-2" class="w-3 h-3"></i> ${car.transmission || 'Manuelle'}
                                    </div>
                                    <div class="ml-auto text-[10px] font-black text-blue-500 uppercase flex items-center gap-1">
                                        Voir <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                });
                lucide.createIcons();

            } catch (err) {
                console.error(err);
                container.innerHTML = '<p class="text-center text-red-500 text-xs font-bold py-10">Erreur lors du chargement des résultats.</p>';
            }
        }

        fetchResults();
    </script>
</body>
</html>
