<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mes Locations - DjuntaCar</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="config.js"></script>

    <style>
        * { font-family: 'Montserrat', sans-serif !important; }
        body { background-color: #fcfcfd; padding-bottom: 100px; margin: 0; }

        /* HEADER */
        header {
            padding: 20px 24px; background: white;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f1f5f9; position: sticky; top: 0; z-index: 50;
        }

        /* CARD LOCATION */
        .rental-card {
            background: white; border-radius: 24px;
            padding: 16px; margin-bottom: 16px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            display: flex; gap: 16px; align-items: center;
            transition: transform 0.2s;
        }
        .rental-card:active { transform: scale(0.98); }
        
        .rental-img {
            width: 80px; height: 80px;
            border-radius: 16px; object-fit: cover;
            background-color: #f1f5f9;
        }

        /* STATUS BADGES */
        .status-badge {
            font-size: 9px; font-weight: 800; text-transform: uppercase;
            padding: 4px 8px; border-radius: 8px; display: inline-block; margin-bottom: 4px;
        }
        .status-pending { background: #fef3c7; color: #d97706; } /* Jaune */
        .status-confirmed { background: #dcfce7; color: #16a34a; } /* Vert */
        .status-completed { background: #f1f5f9; color: #64748b; } /* Gris */
        .status-cancelled { background: #fee2e2; color: #dc2626; } /* Rouge */

        /* MENU BAS */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 12px 24px;
            border-top: 1px solid #f1f5f9;
            display: flex; justify-content: space-between;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; }
        .nav-item.active { color: #1d4379; }
        .nav-item i { width: 24px; height: 24px; }
        .nav-item span { font-size: 9px; font-weight: 700; }
    </style>
</head>
<body>

    <header>
        <h1 class="text-xl font-black text-[#1d4379] uppercase">Mes Locations</h1>
        <button onclick="window.location.href='profile.html'" class="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center text-[#1d4379]">
            <i data-lucide="user" class="w-5 h-5"></i>
        </button>
    </header>

    <main class="max-w-md mx-auto px-6 pt-6">
        
        <div id="loader" class="text-center py-10">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-[#1d4379] mx-auto mb-2"></i>
            <p class="text-xs font-bold text-gray-400">Chargement de l'historique...</p>
        </div>

        <div id="rentals-list" class="space-y-4 hidden">
            </div>

        <div id="empty-state" class="hidden text-center py-20">
            <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="calendar-x" class="w-8 h-8 text-[#1d4379]"></i>
            </div>
            <h3 class="text-lg font-black text-[#1d4379]">Aucune location</h3>
            <p class="text-xs text-gray-400 font-medium mt-2 max-w-[200px] mx-auto">Vous n'avez pas encore réservé de véhicule.</p>
            <button onclick="window.location.href='search-car.html'" class="mt-6 bg-[#1d4379] text-white px-6 py-3 rounded-xl font-black text-xs uppercase shadow-lg">
                Trouver une voiture
            </button>
        </div>

    </main>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i data-lucide="home"></i>
            <span>Accueil</span>
        </a>
        <a href="search-car.html" class="nav-item">
            <i data-lucide="search"></i>
            <span>Trouver</span>
        </a>
        <a href="my-rentals.html" class="nav-item active">
            <i data-lucide="calendar"></i>
            <span>Locations</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i data-lucide="user"></i>
            <span>Compte</span>
        </a>
    </nav>

    <script>
        lucide.createIcons();
        const supabase = window.supabase.createClient(DJUNTA_CONFIG.supabaseUrl, DJUNTA_CONFIG.supabaseKey);

        async function initRentals() {
            // 1. Auth Check
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // 2. Fetch Data (Bookings + info Voiture)
            // On utilise la syntaxe select '*, vehicles(*)' pour faire une jointure automatique
            const { data: bookings, error } = await supabase
                .from('bookings')
                .select('*, vehicles(*)') 
                .eq('renter_id', user.id)
                .order('created_at', { ascending: false });

            // Cacher Loader
            document.getElementById('loader').style.display = 'none';

            if (error) {
                console.error(error);
                alert("Erreur de chargement.");
                return;
            }

            const list = document.getElementById('rentals-list');
            const empty = document.getElementById('empty-state');

            // 3. Affichage
            if (!bookings || bookings.length === 0) {
                empty.classList.remove('hidden');
            } else {
                list.classList.remove('hidden');
                
                bookings.forEach(booking => {
                    const car = booking.vehicles; // Données de la voiture jointe
                    const startDate = new Date(booking.start_date).toLocaleDateString('fr-FR', {day: 'numeric', month: 'short'});
                    const endDate = new Date(booking.end_date).toLocaleDateString('fr-FR', {day: 'numeric', month: 'short'});

                    // Gestion couleur statut
                    let statusClass = 'status-pending';
                    let statusText = 'En attente';
                    
                    if (booking.status === 'confirmed') { statusClass = 'status-confirmed'; statusText = 'Confirmée'; }
                    if (booking.status === 'completed') { statusClass = 'status-completed'; statusText = 'Terminée'; }
                    if (booking.status === 'cancelled') { statusClass = 'status-cancelled'; statusText = 'Annulée'; }

                    const html = `
                    <div class="rental-card">
                        <img src="${car ? car.image_url : ''}" class="rental-img" onerror="this.src='https://via.placeholder.com/150'">
                        <div class="flex-1">
                            <div class="${statusClass} status-badge">${statusText}</div>
                            <h3 class="text-sm font-black text-[#1d4379] truncate">${car ? car.brand + ' ' + car.model : 'Voiture supprimée'}</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <i data-lucide="calendar-days" class="w-3 h-3 text-gray-400"></i>
                                <span class="text-xs font-bold text-gray-500">${startDate} - ${endDate}</span>
                            </div>
                            <p class="text-sm font-black text-[#1d4379] mt-2 text-right">${booking.total_price} CVE</p>
                        </div>
                    </div>`;
                    
                    list.insertAdjacentHTML('beforeend', html);
                });
                
                lucide.createIcons();
            }
        }

        document.addEventListener('DOMContentLoaded', initRentals);
    </script>
</body>
</html>
