<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mes Performances - DjuntaCar</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * { font-family: 'Montserrat', sans-serif !important; }
        body { background-color: #f8fafc; padding-bottom: 40px; }

        .stat-card {
            background: white;
            border-radius: 28px;
            padding: 24px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 15px rgba(0,0,0,0.02);
        }

        .progress-bar {
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #1d4379;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }

        .rating-badge {
            background: #fffbeb;
            color: #b45309;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <header class="h-16 flex items-center px-6 bg-white border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-md mx-auto w-full flex items-center justify-between relative">
            <a href="profile.html" class="p-2 -ml-2 text-gray-400"><i data-lucide="chevron-left" class="w-6 h-6"></i></a>
            <span class="font-bold text-sm text-[#1d4379]">Performances Hôte</span>
            
            <div class="relative cursor-pointer" onclick="toggleNotifications()">
                <i data-lucide="bell" class="w-6 h-6 text-gray-400"></i>
                <span id="notif-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-black w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
                
                <div id="notif-panel" class="absolute top-12 right-0 w-72 bg-white rounded-3xl shadow-2xl border border-gray-100 hidden z-[100] p-4">
                    <h4 class="text-[10px] font-black text-[#1d4379] uppercase mb-4 px-2">Notifications</h4>
                    <div id="notif-list" class="max-h-64 overflow-y-auto space-y-2"></div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto px-6 pt-8">
        
        <div class="stat-card mb-6 bg-[#1d4379] text-white border-none shadow-xl shadow-blue-900/20">
            <span class="text-[10px] font-bold opacity-60 uppercase tracking-widest">Revenus Nets Totaux</span>
            <div class="flex items-baseline gap-2 mt-1">
                <h1 id="total-earnings" class="text-3xl font-black">0 CVE</h1>
            </div>
            <p class="text-[10px] font-bold opacity-60 mt-4 italic">* Commission plateforme (25%) déjà déduite</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="stat-card">
                <i data-lucide="star" class="w-5 h-5 text-amber-500 mb-3"></i>
                <span class="block text-[9px] font-black text-gray-400 uppercase">Note Moyenne</span>
                <p id="avg-rating" class="text-xl font-black text-[#1d4379] mt-1">--</p>
            </div>
            <div class="stat-card">
                <i data-lucide="calendar-check" class="w-5 h-5 text-blue-500 mb-3"></i>
                <span class="block text-[9px] font-black text-gray-400 uppercase">Locations</span>
                <p id="total-rentals" class="text-xl font-black text-[#1d4379] mt-1">0</p>
            </div>
        </div>

        <div class="stat-card mb-8">
            <div class="flex justify-between items-end mb-4">
                <div>
                    <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Taux d'acceptation</span>
                    <p id="acceptance-rate" class="text-2xl font-black text-[#1d4379] mt-1">0%</p>
                </div>
                <i data-lucide="trending-up" class="w-6 h-6 text-green-500"></i>
            </div>
            <div class="progress-bar">
                <div id="acceptance-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <p class="text-[9px] text-gray-400 font-bold mt-4 uppercase">Basé sur vos 50 dernières demandes</p>
        </div>

        <h3 class="text-[11px] font-black text-gray-400 uppercase tracking-widest mb-4">Derniers retours</h3>
        <div id="reviews-list" class="space-y-4">
            <p class="text-center py-10 text-[10px] font-bold text-gray-300 uppercase tracking-widest">Chargement des avis...</p>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        lucide.createIcons();
        const supabase = window.supabase.createClient('URL', 'KEY');
        let userId;

        async function initStats() {
            const { data: { user } } = await supabase.auth.getUser();
            userId = user.id;

            // 1. Calcul des revenus (75% du total price)
            const { data: bookings } = await supabase.from('bookings').select('total_price, status').eq('host_id', userId);
            const finished = bookings.filter(b => b.status === 'completed');
            const total = finished.reduce((sum, b) => sum + (b.total_price * 0.75), 0);
            
            document.getElementById('total-earnings').innerText = Math.round(total).toLocaleString() + ' CVE';
            document.getElementById('total-rentals').innerText = finished.length;

            // 2. Taux d'acceptation
            const approved = bookings.filter(b => b.status !== 'pending' && b.status !== 'cancelled').length;
            const rate = bookings.length > 0 ? Math.round((approved / bookings.length) * 100) : 0;
            document.getElementById('acceptance-rate').innerText = rate + '%';
            document.getElementById('acceptance-fill').style.width = rate + '%';

            // 3. Avis et Note Moyenne
            const { data: reviews } = await supabase.from('reviews').select('*').eq('target_user_id', userId).order('created_at', { ascending: false });
            
            if (reviews && reviews.length > 0) {
                const avg = reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length;
                document.getElementById('avg-rating').innerText = avg.toFixed(1) + ' / 5';
                
                document.getElementById('reviews-list').innerHTML = reviews.slice(0, 3).map(r => `
                    <div class="bg-white p-5 rounded-3xl border border-gray-50">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex gap-1">
                                ${Array(r.rating).fill('<i data-lucide="star" class="w-3 h-3 text-amber-500 fill-amber-500"></i>').join('')}
                            </div>
                            <span class="text-[9px] font-bold text-gray-300">${new Date(r.created_at).toLocaleDateString()}</span>
                        </div>
                        <p class="text-xs font-bold text-gray-600 leading-relaxed italic">"${r.comment || 'Aucun commentaire laissé.'}"</p>
                    </div>
                `).join('');
                lucide.createIcons();
            } else {
                document.getElementById('reviews-list').innerHTML = `<p class="text-center py-10 text-[9px] font-bold text-gray-300 uppercase">Aucun avis reçu pour le moment</p>`;
            }

            loadNotifications();
        }

        async function loadNotifications() {
            const { data: notifs } = await supabase.from('notifications').select('*').eq('user_id', userId).eq('is_read', false);
            const badge = document.getElementById('notif-badge');
            if (notifs && notifs.length > 0) {
                badge.innerText = notifs.length;
                badge.classList.remove('hidden');
            }
            document.getElementById('notif-list').innerHTML = notifs.map(n => `<div class="p-3 bg-blue-50 rounded-2xl text-[10px] font-bold text-[#1d4379]">${n.title}</div>`).join('') || '<p class="text-center py-4 text-[9px] font-bold text-gray-300 uppercase tracking-widest">Rien à signaler</p>';
        }

        function toggleNotifications() { document.getElementById('notif-panel').classList.toggle('hidden'); }
        
        initStats();
    </script>
</body>
</html>
